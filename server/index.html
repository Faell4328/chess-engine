<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" crossorigin="anonymous"></script>
<div style="width: 700px; height: 700px" id="tabuleiro"></div><br />
<input type="text" id="fen" placeholder="FEN personalizado" /><button style="margin-left: 5" onClick="fen_personalizado()">Usar FEN personalizado</button><br /><br />
<button onclick="start()">Posição inicial</button><span style="margin-left: 5">Que é: rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</span>
<audio id="audio" src="#">
</audio>
<script>

  async function fen_personalizado(){
    let campo_input_contendo_fen_personalizado = document.getElementById("fen");

    // Verificando se o FEN está vazio
    if(campo_input_contendo_fen_personalizado == ""){
      alert("O FEN está vazio");
    }

    const retorno = await fetch('http://localhost:4000/fen', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        "fen": campo_input_contendo_fen_personalizado.value
      })
    })
    
    let retornoApi = await retorno.json();

    if(retornoApi == null){
      console.warn("Erro ao consultar API");
      return;
    }

    board.position(campo_input_contendo_fen_personalizado.value);
    campo_input_contendo_fen_personalizado.value = ""
  }
  
  async function start(){
    board.start();
    const retorno = await fetch("http://localhost:4000/resetar", {
      method: 'GET'
    });

    console.log(retorno);

    if(retorno == null || retorno.status !== 200){
      alert("Erro ao consultar API")
    }

    console.clear();
  };

  let origem = null;
  let destino = null;
  let promocao = null;
  
  function onDrop (source, target) {
    origem = null;
    destino = null;
    promocao = null;

    origem = source.toLowerCase();
    destino = target.toLowerCase();
  }

  async function onSnapEnd(){
    let fen = board.fen().split(" ")[0];
    fen = fen.split("/");

    if(fen[0].indexOf("P") != -1){
      promocao = prompt("Você pode promover!\n\"q\" para rainha\n\"r\" para torre\n\"b\" para bispo \n\"n\" para cavalo\nO default é rainha") || "q";
    }
    if(fen[7].indexOf("p") != -1){
      promocao = prompt("Você pode promover!\n\"q\" para rainha\n\"r\" para torre\n\"b\" para bispo \n\"n\" para cavalo\nO default é rainha") || "q";
    }

    const retorno = await fetch('http://localhost:4000/mover', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        "origem": origem,
        "destino": destino,
        "promocao": promocao
      })
    })

    
    let retornoApi = await retorno.json();

    if(retornoApi == null){
      console.warn("Erro ao consultar API");
      return;
    }

    console.log(retornoApi);

    if(retornoApi.status == "ok"){
      console.log(retornoApi.fen);
      document.getElementById("audio").pause();
      document.getElementById("audio").load();
      document.getElementById("audio").src = "movendo.mp3";
      document.getElementById("audio").play();
    }
    else if(retornoApi.status == "Captura"){
      document.getElementById("audio").pause();
      document.getElementById("audio").load();
      document.getElementById("audio").src = "captura.mp3";
      document.getElementById("audio").play();
      console.log(retornoApi.status);
    }
    else if(retornoApi.status == "Xeque mate"){
      document.getElementById("audio").pause();
      document.getElementById("audio").src = "xeque mate.mp3";
      document.getElementById("audio").play();
      alert(retornoApi.status);
    }
    else if(retornoApi.status == "Empate por afogamento" || retornoApi.status == "Empate por repetição"){
      document.getElementById("audio").pause();
      document.getElementById("audio").load();
      document.getElementById("audio").src = "empate.mp3";
      document.getElementById("audio").play();
      alert(retornoApi.status);
    }
    else if(retornoApi.status == "Xeque"){
      document.getElementById("audio").pause();
      document.getElementById("audio").load();
      document.getElementById("audio").src = "xeque.mp3";
      document.getElementById("audio").play();
      console.log(retornoApi.status);
    }
    else{
      console.log(retornoApi.status);
    }
    
    board.position(retornoApi.fen);
    return;
  }

  const board = Chessboard("tabuleiro", {
    position: "start",
    draggable: true,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd
  });
  
</script>